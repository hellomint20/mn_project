<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.care.am.mapper.reservationMapper">

	<resultMap type="com.care.am.dto.reservationDTO" id="reservation">
		<id property="rNum" column="r_num"/>
		<result property="mId" column="m_id"/>
		<result property="cId" column="c_id"/>
		<result property="rContent" column="r_content"/>
		<result property="rDate" column="r_date"/>
		<result property="rTime" column="r_time"/>
		<result property="rApply" column="r_apply"/>
		<result property="rName" column="r_name"/>
		<result property="rTel" column="r_tel"/>
	</resultMap>
	
	<resultMap type="com.care.am.dto.petDTO" id="pet">
		<id property="pNum" column="p_num"/>
		<result property="pName" column="p_name" />
		<result property="pSection" column="p_section" />
		<result property="pType" column="p_type" />
		<result property="pAge" column="p_age" />
		<result property="pSex" column="p_sex" />
		<result property="cId" column="c_id" />
		<result property="pPhoto" column="pPhoto" />
	</resultMap>
	
	<select id="reservationList" resultType="map">
		select reservation.r_num, reservation.r_date, reservation.r_time, pet.p_name, medi.m_name, reservation.r_apply, reservation.r_content
		from reservation
		join medi ON reservation.m_id = medi.m_id
		join pet ON reservation.p_num = pet.p_num where reservation.c_id=#{cId} order by reservation.r_date asc, reservation.r_time asc 
	</select>
	
	<select id="customerResList" resultType="map">
		SELECT *
			FROM (
				SELECT format(@rownum:= @rownum+1, 0) as RN, A.*
					FROM (
						select reservation.r_num, reservation.r_date, reservation.r_time, pet.p_name, medi.m_name,
								reservation.r_apply, reservation.r_content
									from reservation
											join medi ON reservation.m_id = medi.m_id
											join pet ON reservation.p_num = pet.p_num where reservation.c_id=#{id} order
											by reservation.r_date desc, reservation.r_time asc
							) A, (select @rownum :=0,0) R
				) B
		WHERE RN BETWEEN ${start} AND ${end}
	</select> 

	<select id="mediList" resultType="map">
		select * from medi
	</select>
	
	<select id="mediSearch" resultType="int">
		select count(*) from medi where m_name like CONCAT('%', #{mName}, '%')
	</select>
	
	<select id="mediSelectSearch" resultType="map">
		<![CDATA[
		SELECT *
   			FROM (
      				SELECT format(@rownum:= @rownum+1, 0) as RN, A.* 
         				FROM (
               				SELECT * 
              					 FROM medi 
              					 	WHERE m_name LIKE CONCAT('%', #{mName}, '%')
                  						ORDER BY m_name ASC 
               					) A, (select @rownum :=0,0) R
         		) B
		WHERE RN BETWEEN ${start} AND ${end}
		]]>
	</select>
	
	<select id="mediInfo" resultType="map">
		select * from medi where m_id = #{mediId}
	</select>
	
	<select id="mediTime" resultType="map">
		select open_time, lunch_start_time, close_time, lunch_end_time
			from medi 
		where m_id = #{mediId}
	</select>

	<select id="petList" resultType="map">
		select * from pet where c_id = #{c_id}
	</select>
	
	<insert id="reservationRegister">
		    insert into reservation 
      		(r_num, m_id, p_num, c_id, r_content, r_date, r_time, r_name, r_tel)
      		values (r_num, #{mId}, 
            (select p_num from pet where p_name=#{pName} and c_id=#{cId} ),#{cId}, #{rContent}, #{rDate}, #{rTime}, #{rName}, #{rTel})
	</insert>

	<select id="reservationTime" resultType="map">
		select count(r_time) 
			from reservation 
		where r_date=#{date} order by r_time asc
	</select>
	
	<select id="reservationCount" resultType="map">
		select r_time, count(*) 
			from reservation 
		where m_id=#{mId} and 
				r_date =#{rDate} group by r_time
	</select>
	
	<select id="peopleCount" resultType="map">
		select count(*) 
			from reservation 
		where m_id=#{mId} 
				and r_date = #{rDate} and r_time = #{rTime}
	</select>
	
	<select id="mediSelectList" resultType="map">
	<![CDATA[
		SELECT *
   			FROM (
      				SELECT format(@rownum:= @rownum+1, 0) as RN, A.* 
         				FROM (
               				SELECT * 
              					 FROM medi 
                  					ORDER BY m_name ASC 
               					) A, (select @rownum :=0,0) R
         		) B
		WHERE RN BETWEEN ${start} AND ${end}
		]]>
	</select>
	
	<select id="reservationCheck" resultType="map">
		select reservation.m_id, reservation.r_date, reservation.r_time,pet.p_num
			from reservation join pet on reservation.p_num = pet.p_num
			where m_id=#{mId} and r_date = #{rDate} and r_time = #{rTime} and p_name=#{pName};
	</select>

	<update id="reserCancel">
		update reservation set r_apply="취소" where r_num=#{rNum}
	</update>
	
	<update id="reserState">
		update reservation set r_apply=#{apply} where r_num=#{num}
	</update>


	<select id="mediReservationList" resultType="map">
		select
	reservation.r_date, reservation.r_time, pet.p_type, reservation.r_content, reservation.r_apply
		from reservation left join pet
			on reservation.p_num = pet.p_num
				where reservation.m_id = #{mId} and not r_apply in ("대기")
	</select>
	
	<select id="mediReservationWaitList" resultType="map">
		select
		reservation.r_num, reservation.r_date, reservation.r_time, pet.p_type, reservation.r_content, reservation.r_apply
		from reservation left join pet
			on reservation.p_num = pet.p_num
		where reservation.m_id = #{mId} and r_apply= "대기"
	</select>
	
	<select id="reservationInfo" resultType="map">
		select customer.c_email, reservation.r_date, reservation.r_time, reservation.r_name, customer.c_tel, pet.p_section, pet.p_type, pet.p_name, pet.p_sex, pet.p_age, reservation.r_content, pet.p_photo
		from reservation 
		join customer on reservation.c_id = customer.c_id
    	join pet on reservation.p_num = pet.p_num
		where reservation.r_num = #{rNum}
	</select>

</mapper>